# POS Offline - نظام نقاط البيع المتكامل

نظام نقاط بيع احترافي متعدد المستأجرين، يدعم العمل بدون اتصال كتطبيق Windows و Android مع تزامن يدوي مع السيرفر. مصمم بالكامل باللغة العربية (RTL).

---

## التقنيات المستخدمة

| الطبقة | التقنية |
|--------|---------|
| Backend | Node.js / Express 4.18 |
| Database | SQLite (قاعدة رئيسية + قاعدة لكل مستأجر) |
| Frontend | Vanilla JavaScript ES6+ / HTML5 / CSS3 |
| PWA | Service Worker v40 / IndexedDB v5 |
| Desktop | Electron (Windows) |
| Mobile | Capacitor (Android) |
| Sync | REST API مع تزامن يدوي |
| Deploy | Docker / Nginx Proxy Manager |

---

## التشغيل كتطبيق Desktop (Windows)

```bash
npm install
npm run electron:dev        # تشغيل تطوير
npm run electron:build      # بناء ملف exe
```

## التشغيل كتطبيق Android

```bash
npm install
npx cap add android
npx cap sync
npx cap open android        # فتح في Android Studio
```

## نظام المزامنة

- **مزامنة يدوية**: الأدمن يضغط زر "مزامنة يدوية" من شاشة الأدمن
- **مزامنة كاملة**: إعادة تحميل جميع البيانات من السيرفر
- **API المزامنة**:
  - `POST /api/sync/upload` - رفع فواتير وعملاء
  - `GET /api/sync/download` - تحميل بيانات محدثة
  - `GET /api/sync/full-download` - تحميل كامل
  - `GET /api/sync/status` - حالة السيرفر

---

## الميزات الكاملة

### 1. نقطة البيع (POS)
- سلة مشتريات ديناميكية مع حفظ تلقائي لكل مستخدم
- مسح الباركود بقارئ خارجي (دعم متغيرات المنتج)
- بحث سريع عن المنتجات
- اختيار العميل من قائمة بحث بالاسم أو رقم الهاتف
- طرق دفع متعددة مع أرقام العمليات
- ترقيم تلقائي للفواتير مع بادئة خاصة بكل مستخدم

### 2. المنتجات
- إضافة / تعديل / حذف المنتجات
- رفع صور المنتجات (ضغط وتصغير تلقائي)
- تصنيفات تلقائية
- نظام المتغيرات (مقاسات، ألوان...) مع سعر وتكلفة وباركود لكل متغير
- نظام التكاليف الديناميكي المرن (تغليف، شحن، مناولة...)

### 3. المخزون
- إدارة مخزون مركزية منفصلة عن المنتجات
- توزيع المخزون على الفروع
- تتبع الكميات والتكاليف
- تنبيهات المخزون المنخفض
- ربط المتغيرات بالمخزون

### 4. الفواتير والمبيعات
- إنشاء وعرض وطباعة الفواتير
- طباعة حرارية (57mm x 40mm) للإيصالات
- طباعة عادية بتنسيق كامل
- حفظ الفواتير محلياً للعمل بدون اتصال
- تصدير إلى CSV/Excel
- حالة الطلب (قيد التنفيذ)
- حذف جماعي للفواتير (صلاحية المسؤول)

### 5. العملاء (CRM)
- قاعدة بيانات عملاء كاملة (اسم، هاتف، بريد، عنوان، ملاحظات)
- بحث سريع في نقطة البيع بالاسم أو الهاتف
- إضافة عميل سريعة من نقطة البيع
- إضافة عملاء بدون اتصال مع مزامنة تلقائية
- عرض سجل فواتير العميل
- تصدير قائمة العملاء إلى Excel

### 6. نظام الولاء
- نقاط مكافآت لكل فاتورة (قابلة للتخصيص)
- قيمة نقدية للنقاط
- استبدال النقاط كخصم على الفاتورة
- عرض فوري للنقاط المكتسبة والمستبدلة
- تعديل يدوي لنقاط العميل

### 7. الكوبونات والخصومات
- إنشاء كوبونات بأكواد (مبلغ ثابت أو نسبة)
- حد أقصى للاستخدام وتاريخ انتهاء
- حد أدنى للشراء
- تتبع عدد الاستخدامات
- تفعيل وتعطيل الكوبونات

### 8. المرتجعات
- إنشاء فواتير مرتجعات
- تتبع حالة المرتجعات
- طباعة إيصالات المرتجعات (عادية وحرارية)
- بحث وتصفية المرتجعات

### 9. الإدارة المالية
- تتبع المصروفات بتصنيفات متعددة
- ربط المصروفات بالفروع
- تفاصيل الرواتب (تفصيل لكل موظف)
- تقرير الأرباح والخسائر
- أداة تقييم DCF (التدفقات النقدية المخصومة)

### 10. التقارير والتحليلات
- تقرير المبيعات اليومي/الفترة مع التفصيل حسب طريقة الدفع
- تقرير المخزون ومستويات المخزون
- تقرير التالف
- ترتيب المنتجات الأكثر مبيعاً
- تقرير المخزون المنخفض
- تقرير مبيعات المنتجات مع رسوم بيانية (Chart.js)
- تقرير مبيعات الفروع مع مقارنة بصرية
- تصدير جميع التقارير إلى Excel

### 11. سجل النظام
- تسجيل جميع العمليات (إنشاء، تعديل، حذف)
- تفاصيل العملية والمستخدم والوقت
- تصفية حسب نوع العملية أو التاريخ

### 12. الفروع
- إنشاء وإدارة فروع متعددة
- عزل كامل للبيانات بين الفروع
- ربط المستخدمين بالفروع
- توزيع المخزون على الفروع
- تقارير موحدة عبر الفروع

### 13. الحضور والانصراف
- تسجيل وقت الحضور والانصراف
- سجل حضور كامل مع التصفية حسب الموظف
- دعم المنطقة الزمنية (الكويت UTC+3)

### 14. الموردين
- قاعدة بيانات موردين (اسم، هاتف، بريد، عنوان)
- تتبع فواتير الموردين
- رفع مستندات الفواتير (PDF/صور)
- ملاحظات على فواتير الموردين

### 15. طاولات المطعم
- إنشاء وإدارة الطاولات (اسم، سعة، موقع)
- خريطة بصرية لتخطيط المطعم
- تتبع حالة الطاولات (متاحة/مشغولة)
- ربط الفاتورة بالطاولة
- تحرير الطاولة بعد إتمام الفاتورة

### 16. العمليات الإضافية
- إضافة بنود يدوية للفاتورة (تغليف، توصيل...)
- مبالغ مخصصة لكل عملية
- حساب ضريبي اختياري

### 17. المستخدمين والصلاحيات
- إنشاء وإدارة المستخدمين
- 18+ نوع صلاحية:
  - عرض/إضافة/تعديل/حذف المنتجات
  - عرض/إضافة/تعديل/حذف المخزون
  - عرض/حذف الفواتير
  - عرض/إضافة/تعديل/حذف العملاء
  - عرض التقارير، المحاسبة، إدارة المستخدمين، الإعدادات
- إخفاء/إظهار الأقسام حسب صلاحيات المستخدم

### 18. الإعدادات
- اسم المتجر وشعاره
- أيقونة صفحة الدخول
- إعدادات العملة
- إعدادات نظام الولاء

---

## Multi-Tenancy (تعدد المستأجرين)

- لوحة تحكم Super Admin
- إنشاء وإدارة مستأجرين (متاجر) متعددة
- قاعدة بيانات منفصلة لكل مستأجر
- خطط اشتراك (أساسي، متميز، مؤسسي)
- حد أقصى للمستخدمين والفروع لكل خطة
- إدارة فواتير الاشتراكات (مبالغ، فترات، طرق دفع)
- حساب الأيام المتبقية وتنبيهات انتهاء الاشتراك
- إحصائيات لكل مستأجر (مستخدمين، فروع، منتجات، فواتير، مبيعات)

---

## PWA والعمل بدون اتصال

### Service Worker (v30)
- استراتيجية Network First للملفات الأساسية (JS/CSS/HTML)
- كاش API للطلبات GET فقط
- تجاوز الكاش لطلبات فحص الاتصال (`?_ping`)
- حذف تلقائي للكاش القديم عند التحديث
- إعادة تحميل تلقائية عند تفعيل SW جديد (`controllerchange`)
- `skipWaiting()` + `clients.claim()` للتفعيل الفوري

### IndexedDB (v3)
| Store | الوظيفة |
|-------|---------|
| products | كاش المنتجات محلياً |
| pending_invoices | فواتير بانتظار المزامنة |
| local_invoices | سجل فواتير محلي |
| user_data | بيانات المستخدم |
| pending_customers | عملاء بانتظار المزامنة |

### فحص الاتصال الحقيقي
- `navigator.onLine` غير موثوق! يرجع `true` حتى مع انقطاع فعلي
- فحص حقيقي بـ ping للسيرفر كل 5 ثواني مع timeout 3 ثواني
- تعطيل زر الخروج فوراً عند اكتشاف انقطاع حقيقي

### المزامنة التلقائية
- مزامنة دورية كل 5 دقائق
- مزامنة فورية عند عودة الاتصال (خلال 5 ثواني)
- رفع الفواتير المعلقة تلقائياً
- رفع العملاء المحفوظين محلياً
- تحديث المنتجات من السيرفر

---

## الأمان

- تشفير كلمات المرور (SHA256)
- منع تسجيل الخروج بدون اتصال (حماية رباعية: CSS + disabled + click interceptor + inline check)
- عزل بيانات المستأجرين (X-Tenant-ID header)
- تحقق من الصلاحيات على مستوى السيرفر
- تأكيد مزدوج للعمليات الحساسة (الحذف)

---

## هيكل المشروع

```
Pos-Offline/
├── package.json           # إعدادات المشروع و electron-builder
├── Dockerfile
├── docker-compose.yml
├── electron/
│   ├── main.js            # نقطة دخول Electron
│   └── server.js          # Node.js/Express Backend
├── routes/
│   ├── usersProductsInvoices.js
│   ├── tablesCouponsBackups.js
│   ├── stockTransfersSubscriptionsSync.js
│   └── adminDashboardXbrlShifts.js
├── frontend/
│   ├── index.html         # الواجهة الرئيسية
│   ├── app.js             # المنطق الرئيسي
│   ├── style.css          # التصميم
│   ├── products-search.js # بحث المنتجات المتقدم
│   ├── localdb.js         # IndexedDB wrapper
│   ├── sync-manager.js    # إدارة المزامنة
│   ├── sw.js              # Service Worker
│   └── manifest.json      # PWA manifest
├── database/
│   └── pos.db             # قاعدة البيانات الرئيسية
└── .github/workflows/
    ├── ci.yml             # فحص تلقائي عند كل push
    └── release.yml        # بناء ريليس عند دفع tag
```

---

## التثبيت والتشغيل

### متطلبات التشغيل
- Docker + Docker Compose
- أو Python 3.11+ مع pip

### عبر Docker

```bash
# بناء وتشغيل
docker-compose build --no-cache
docker-compose up -d

# التحقق
docker-compose ps
docker-compose logs pos | tail -50
```

### عبر Python مباشرة

```bash
pip install -r requirements.txt
python server.py
```

### بعد التثبيت

```
1. افتح المتصفح: http://localhost:5000
2. سجل الدخول: admin / admin
3. للـ Super Admin: admin+superadmin# / admin
```

---

## إنشاء ريليس جديد (Release)

عند الانتهاء من التعديلات ودمجها في `main`، نفّذ الأوامر التالية لإنشاء ريليس:

```bash
# 1. اسحب آخر تحديثات
git fetch origin

# 2. روح على main
git checkout main

# 3. حدّث main
git pull origin main

# 4. ادمج فرع التطوير
git merge origin/claude/pos-offline-mobile-3QbTW

# 5. أنشئ tag للريليس (غيّر رقم النسخة حسب الحاجة)
git tag v1.0.3

# 6. ادفع main مع الـ tag
git push origin main --tags
```

> بعد دفع الـ tag، GitHub Actions يشتغل تلقائياً ويسوي:
> 1. بناء ملف `.exe` لـ Windows
> 2. بناء Docker image
> 3. إنشاء GitHub Release مع رفع الملفات
>
> تابع التقدم من تبويب **Actions** في صفحة الريبو على GitHub.

---

## الإعدادات الافتراضية

| الإعداد | القيمة |
|---------|--------|
| المنطقة الزمنية | Asia/Kuwait (UTC+3) |
| العملة | دينار كويتي (KWD) |
| اللغة | العربية |
| الاتجاه | RTL |
| البورت | 5000 |

---

## إحصائيات المشروع

| البند | العدد |
|-------|-------|
| أسطر Backend | ~3,700 |
| أسطر Frontend JS | ~8,400 |
| أسطر HTML | ~1,800 |
| أسطر CSS | ~880 |
| نقاط API | 96+ |
| دوال JavaScript | 245+ |
| أنواع الصلاحيات | 18+ |
| جداول قاعدة البيانات | 30+ |
