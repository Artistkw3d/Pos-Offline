diff --git a/server.py b/server.py
index 23b3bce..e6fbff8 100644
--- a/server.py
+++ b/server.py
@@ -21,6 +21,7 @@ import json
 import re
 import hashlib
 import jwt
+from werkzeug.security import generate_password_hash, check_password_hash
 
 from db_modules.schema import create_all_tables, create_indexes, insert_default_settings, insert_default_branch
 from db_modules.master import init_master_db as _init_master_db
@@ -31,6 +32,12 @@ CORS(app)
 
 # === License enforcement constants ===
 LICENSE_SECRET = os.environ.get('POS_LICENSE_SECRET', 'pos-offline-license-secret-v1')
+if LICENSE_SECRET == 'pos-offline-license-secret-v1' and not os.environ.get('POS_ALLOW_DEFAULT_SECRET'):
+    import warnings
+    warnings.warn(
+        "WARNING: Using default LICENSE_SECRET. Set POS_LICENSE_SECRET environment variable for production security.",
+        stacklevel=1
+    )
 LICENSE_GRACE_DAYS = 7
 
 # إعدادات قواعد البيانات
@@ -48,8 +55,25 @@ os.makedirs(BACKUPS_DIR, exist_ok=True)
 # ===== نظام Multi-Tenancy =====
 
 def hash_password(password):
-    """تشفير كلمة المرور"""
-    return hashlib.sha256(password.encode('utf-8')).hexdigest()
+    """تشفير كلمة المرور باستخدام PBKDF2 (آمن)"""
+    return generate_password_hash(password, method='pbkdf2:sha256', salt_length=16)
+
+def verify_password(password, stored_hash):
+    """التحقق من كلمة المرور - يدعم الهاش القديم (SHA-256) والجديد (PBKDF2)"""
+    if not stored_hash:
+        return False
+    # الهاش القديم: SHA-256 بطول 64 حرف hex
+    if len(stored_hash) == 64 and all(c in '0123456789abcdef' for c in stored_hash):
+        return hashlib.sha256(password.encode('utf-8')).hexdigest() == stored_hash
+    # الهاش الجديد: PBKDF2
+    return check_password_hash(stored_hash, password)
+
+def needs_rehash(stored_hash):
+    """هل كلمة المرور بحاجة لإعادة تشفير؟"""
+    if not stored_hash:
+        return False
+    # SHA-256 القديم = 64 hex chars
+    return len(stored_hash) == 64 and all(c in '0123456789abcdef' for c in stored_hash)
 
 def init_master_db():
     """إنشاء قاعدة البيانات الرئيسية للمستأجرين"""
@@ -186,7 +210,6 @@ def login():
         ensure_user_permission_columns(cursor)
         conn.commit()
 
-        hashed_pw = hash_password(password)
         cursor.execute('''
             SELECT u.*, b.name as branch_name
             FROM users u
@@ -198,11 +221,12 @@ def login():
 
         if user:
             stored_pw = user['password']
-            # دعم كلمات المرور القديمة (نص عادي) والجديدة (مشفرة)
-            if stored_pw == hashed_pw or stored_pw == password:
-                # ترقية كلمة المرور القديمة إلى مشفرة تلقائياً
-                if stored_pw == password and stored_pw != hashed_pw:
-                    cursor.execute('UPDATE users SET password = ? WHERE id = ?', (hashed_pw, user['id']))
+            # دعم كلمات المرور القديمة (نص عادي + SHA-256) والجديدة (PBKDF2)
+            if verify_password(password, stored_pw) or stored_pw == password:
+                # ترقية كلمة المرور القديمة إلى PBKDF2 تلقائياً
+                if needs_rehash(stored_pw) or stored_pw == password:
+                    new_hash = hash_password(password)
+                    cursor.execute('UPDATE users SET password = ? WHERE id = ?', (new_hash, user['id']))
                 # تحديث وقت آخر دخول
                 cursor.execute('UPDATE users SET last_login = CURRENT_TIMESTAMP WHERE id = ?', (user['id'],))
                 conn.commit()
@@ -3294,11 +3318,15 @@ def super_admin_login():
         password = data.get('password', '')
         conn = get_master_db()
         cursor = conn.cursor()
-        cursor.execute('SELECT * FROM super_admins WHERE username = ? AND password = ?',
-                       (username, hash_password(password)))
+        cursor.execute('SELECT * FROM super_admins WHERE username = ?', (username,))
         admin = cursor.fetchone()
-        conn.close()
-        if admin:
+        if admin and verify_password(password, admin['password']):
+            # ترقية الهاش القديم إلى PBKDF2 تلقائياً
+            if needs_rehash(admin['password']):
+                cursor.execute('UPDATE super_admins SET password = ? WHERE id = ?',
+                               (hash_password(password), admin['id']))
+                conn.commit()
+            conn.close()
             return jsonify({
                 'success': True,
                 'admin': {
@@ -3308,6 +3336,7 @@ def super_admin_login():
                     'role': 'super_admin'
                 }
             })
+        conn.close()
         return jsonify({'success': False, 'error': 'بيانات الدخول غير صحيحة'}), 401
     except Exception as e:
         return jsonify({'success': False, 'error': str(e)}), 500
@@ -3387,7 +3416,7 @@ def create_tenant():
         t_cursor.execute('''
             INSERT INTO users (username, password, full_name, role, invoice_prefix, is_active, branch_id)
             VALUES (?, ?, ?, 'admin', 'INV', 1, 1)
-        ''', (admin_username, admin_password, owner_name))
+        ''', (admin_username, hash_password(admin_password), owner_name))
         t_conn.commit()
         t_conn.close()
 
@@ -3589,10 +3618,9 @@ def super_admin_change_password():
         new_full_name = data.get('new_full_name', '').strip()
         conn = get_master_db()
         cursor = conn.cursor()
-        cursor.execute('SELECT * FROM super_admins WHERE id = ? AND password = ?',
-                       (admin_id, hash_password(old_password)))
+        cursor.execute('SELECT * FROM super_admins WHERE id = ?', (admin_id,))
         admin = cursor.fetchone()
-        if not admin:
+        if not admin or not verify_password(old_password, admin['password']):
             conn.close()
             return jsonify({'success': False, 'error': 'كلمة المرور القديمة غير صحيحة'}), 400
 
